#include <Arduino.h>
#include <SoftwareSerial.h>
#include <DHT.h>
#include <Wire.h>
#include <Stepper.h>
#include <RTClib.h>  // RTC ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

// ========== í•€ ì •ì˜ ==========
// DHT22 ì˜¨ìŠµë„ ì„¼ì„œ
#define DHT_PIN 2
#define DHT_TYPE DHT22

// ì¡°ë„ ì„¼ì„œ (LDR)
#define LIGHT_SENSOR_PIN A1

// ì›Œí„°íŒí”„ (DC380 íŒí”„ëª¨í„° 2ê°œ)
#define PUMP1_PIN 3
#define PUMP2_PIN 4

// íŒ¬ 4ê°œ (ëƒ‰ê°/ìˆœí™˜ìš©)
#define FAN1_PIN 5
#define FAN2_PIN 6
#define FAN3_PIN 7
#define FAN4_PIN 8

// LED ì¡°ëª… (ì„±ì¥ë“±)
#define LED_PIN 9

// ìŠ¤í…ëª¨í„° (CNC ë¦¬ë‹ˆì–´ ê°€ì´ë“œ) - ë“œë¼ì´ë²„ ì—°ê²°
#define STEP_PIN 10
#define DIR_PIN 11
#define ENABLE_PIN 12

// ESP32 í†µì‹  (ìœ ì„ )
SoftwareSerial esp32Serial(A2, A3); // RX, TX

// ì„¼ì„œ ë° RTC ê°ì²´
DHT dht(DHT_PIN, DHT_TYPE);
Stepper stepper(200, STEP_PIN, DIR_PIN); // 200ìŠ¤í…/íšŒì „
RTC_DS1307 rtc;  // RTC ê°ì²´

// ========== ìƒì¶” ì¬ë°° ìµœì  í™˜ê²½ ì„¤ì • ==========
const float OPTIMAL_TEMP_MIN = 15.0;    // ìµœì  ì˜¨ë„ í•˜í•œ
const float OPTIMAL_TEMP_MAX = 20.0;    // ìµœì  ì˜¨ë„ ìƒí•œ
const float OPTIMAL_HUMIDITY_MIN = 60.0; // ìµœì  ìŠµë„ í•˜í•œ
const float OPTIMAL_HUMIDITY_MAX = 80.0; // ìµœì  ìŠµë„ ìƒí•œ
const int OPTIMAL_LIGHT_MIN = 300;       // ì¡°ë„ í•˜í•œ (0-1023)
const int OPTIMAL_LIGHT_MAX = 600;       // ì¡°ë„ ìƒí•œ

// ========== ì‹œê°„ ê¸°ë°˜ ì œì–´ ì„¤ì • ==========
// LED ì¡°ëª… ì‹œê°„ (24ì‹œê°„ ê¸°ì¤€)
const int LED_ON_HOUR = 6;    // ì˜¤ì „ 6ì‹œ
const int LED_OFF_HOUR = 22;  // ì˜¤í›„ 10ì‹œ

// ë¬¼ì£¼ê¸° ì‹œê°„ (ë§¤ì¼ 2ë²ˆ: ì˜¤ì „ 8ì‹œ, ì˜¤í›„ 6ì‹œ)
const int WATERING_HOUR_1 = 8;   // ì˜¤ì „ 8ì‹œ
const int WATERING_HOUR_2 = 18;  // ì˜¤í›„ 6ì‹œ
const int WATERING_MINUTE = 0;   // ì •ê°
const unsigned long WATERING_DURATION = 30000UL; // 30ì´ˆê°„ ë¬¼ì£¼ê¸°

// ì„ í˜• ì•¡ì¶”ì—ì´í„° ì´ë™ ì‹œê°„ (ë§¤ì¼ ì˜¤ì „ 10ì‹œ, ì˜¤í›„ 3ì‹œ)
const int LINEAR_MOVE_HOUR_1 = 10;  // ì˜¤ì „ 10ì‹œ
const int LINEAR_MOVE_HOUR_2 = 15;  // ì˜¤í›„ 3ì‹œ
const int LINEAR_MOVE_MINUTE = 0;   // ì •ê°

// ========== ì „ì—­ ë³€ìˆ˜ ==========
float temperature = 0;
float humidity = 0;
int lightLevel = 0;
bool pumpStatus = false;
bool fanStatus = false;
bool ledStatus = false;
int linearPosition = 0;

// RTC ì‹œê°„ ê´€ë¦¬ ë³€ìˆ˜
DateTime now;
bool wateringActive = false;
unsigned long wateringStartTime = 0;
bool todayWatering1Done = false;
bool todayWatering2Done = false;
bool todayLinearMove1Done = false;
bool todayLinearMove2Done = false;
int lastDay = -1;  // ë‚ ì§œ ë³€ê²½ ê°ì§€ìš©

// ì„¼ì„œ ë° í†µì‹  íƒ€ì´ë¨¸
unsigned long lastSensorRead = 0;
unsigned long lastESP32Send = 0;
unsigned long lastRTCRead = 0;
const unsigned long SENSOR_INTERVAL = 2000;      // 2ì´ˆë§ˆë‹¤ ì„¼ì„œ ì½ê¸°
const unsigned long ESP32_SEND_INTERVAL = 10000; // 10ì´ˆë§ˆë‹¤ ESP32ë¡œ ì „ì†¡
const unsigned long RTC_READ_INTERVAL = 1000;    // 1ì´ˆë§ˆë‹¤ RTC ì½ê¸°

// ========== í•¨ìˆ˜ ì„ ì–¸ ==========
void initializeRTC();
void readRTC();
void readSensors();
void timeBasedControl();
void environmentalControl();
void sendToESP32();
void activatePumps(bool activate);
void activateFans(bool activate);
void activateLED(bool activate);
void moveLinearActuator();
void scheduledWatering();
void scheduledLinearMove();
void emergencyStop();
void printSystemStatus();
void resetDailyTasks();
bool isTimeForLED();
bool isTimeToWater();
bool isTimeToMovePlant();
String formatTime(DateTime dt);
String formatDate(DateTime dt);

void setup() {
  Serial.begin(9600);
  esp32Serial.begin(9600);
  
  // I2C í†µì‹  ì´ˆê¸°í™” (RTCìš©)
  Wire.begin();
  
  // RTC ì´ˆê¸°í™”
  initializeRTC();
  
  // ì„¼ì„œ ì´ˆê¸°í™”
  dht.begin();
  
  // í•€ ëª¨ë“œ ì„¤ì •
  pinMode(PUMP1_PIN, OUTPUT);
  pinMode(PUMP2_PIN, OUTPUT);
  pinMode(FAN1_PIN, OUTPUT);
  pinMode(FAN2_PIN, OUTPUT);
  pinMode(FAN3_PIN, OUTPUT);
  pinMode(FAN4_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(ENABLE_PIN, OUTPUT);
  
  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
  digitalWrite(PUMP1_PIN, LOW);
  digitalWrite(PUMP2_PIN, LOW);
  digitalWrite(FAN1_PIN, LOW);
  digitalWrite(FAN2_PIN, LOW);
  digitalWrite(FAN3_PIN, LOW);
  digitalWrite(FAN4_PIN, LOW);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(ENABLE_PIN, HIGH); // ìŠ¤í…ëª¨í„° í™œì„±í™”
  
  // ìŠ¤í…ëª¨í„° ì„¤ì •
  stepper.setSpeed(60); // RPM
  
  // ì‹œì‘ ë©”ì‹œì§€
  Serial.println("========================================");
  Serial.println("ìŠ¤ë§ˆíŠ¸íŒœ ìƒì¶”ì¬ë°° ì‹œìŠ¤í…œ ì‹œì‘ (RTC ëª¨ë“ˆ)");
  Serial.println("ì‹œê°„ ê¸°ë°˜ + í™˜ê²½ ê¸°ë°˜ ì œì–´ ëª¨ë“œ");
  Serial.println("========================================");
  Serial.println("ì œì–´ ìŠ¤ì¼€ì¤„:");
  Serial.println("- LED ì¡°ëª…: 06:00-22:00 (16ì‹œê°„)");
  Serial.println("- ë¬¼ì£¼ê¸°: 08:00, 18:00 (30ì´ˆê°„)");
  Serial.println("- ì‹ë¬¼ì´ë™: 10:00, 15:00");
  Serial.println("- í™˜ê²½ì œì–´: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§");
  Serial.println("========================================");
  
  // í˜„ì¬ ì‹œê°„ í‘œì‹œ
  readRTC();
  Serial.print("í˜„ì¬ ì‹œê°„: ");
  Serial.println(formatTime(now));
  Serial.print("í˜„ì¬ ë‚ ì§œ: ");
  Serial.println(formatDate(now));
  Serial.println("========================================");
  
  delay(2000);
}

void loop() {
  unsigned long currentTime = millis();
  
  // RTC ì‹œê°„ ì½ê¸°
  if (currentTime - lastRTCRead >= RTC_READ_INTERVAL) {
    readRTC();
    lastRTCRead = currentTime;
  }
  
  // ì„¼ì„œ ë°ì´í„° ì½ê¸°
  if (currentTime - lastSensorRead >= SENSOR_INTERVAL) {
    readSensors();
    timeBasedControl();      // ì‹œê°„ ê¸°ë°˜ ì œì–´ ë¨¼ì €
    environmentalControl();  // í™˜ê²½ ê¸°ë°˜ ì œì–´ í›„
    printSystemStatus();
    lastSensorRead = currentTime;
  }
  
  // ESP32ë¡œ ë°ì´í„° ì „ì†¡
  if (currentTime - lastESP32Send >= ESP32_SEND_INTERVAL) {
    sendToESP32();
    lastESP32Send = currentTime;
  }
  
  // ë¬¼ì£¼ê¸° ì§€ì† ì‹œê°„ ì²´í¬
  if (wateringActive && (currentTime - wateringStartTime >= WATERING_DURATION)) {
    activatePumps(false);
    wateringActive = false;
    Serial.println("â° ì •ê¸° ë¬¼ì£¼ê¸° ì™„ë£Œ");
  }
  
  delay(100);
}

void initializeRTC() {
  if (!rtc.begin()) {
    Serial.println("âŒ RTC ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
    while (1);
  }
  
  // RTCê°€ ì‘ë™ ì¤‘ì´ ì•„ë‹ˆë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
  if (!rtc.isrunning()) {
    Serial.println("âš ï¸ RTCê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì»´íŒŒì¼ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.");
    // ì•„ë˜ ì¤„ì˜ ì£¼ì„ì„ í•´ì œí•˜ë©´ ì»´íŒŒì¼ ì‹œê°„ìœ¼ë¡œ RTC ì„¤ì •
    // rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
    
    // ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œê°„ ì„¤ì • (ë…„, ì›”, ì¼, ì‹œ, ë¶„, ì´ˆ)
    // rtc.adjust(DateTime(2025, 7, 14, 12, 0, 0));  // 2025ë…„ 7ì›” 14ì¼ 12ì‹œ 0ë¶„ 0ì´ˆ
  }
  
  Serial.println("âœ… RTC ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ");
}

void readRTC() {
  now = rtc.now();
  
  // ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì¼ì¼ ì‘ì—… ë¦¬ì…‹
  if (lastDay != now.day()) {
    resetDailyTasks();
    lastDay = now.day();
    Serial.println("ğŸ“… ìƒˆë¡œìš´ ë‚  - ì¼ì¼ ì‘ì—… ë¦¬ì…‹");
  }
}

void resetDailyTasks() {
  todayWatering1Done = false;
  todayWatering2Done = false;
  todayLinearMove1Done = false;
  todayLinearMove2Done = false;
}

void readSensors() {
  // ì˜¨ìŠµë„ ì„¼ì„œ ì½ê¸°
  temperature = dht.readTemperature();
  humidity = dht.readHumidity();
  
  // ì¡°ë„ ì„¼ì„œ ì½ê¸°
  lightLevel = analogRead(LIGHT_SENSOR_PIN);
  
  // ì„¼ì„œ ì˜¤ë¥˜ ì²´í¬
  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("âŒ DHT ì„¼ì„œ ì½ê¸° ì˜¤ë¥˜!");
    temperature = 0;
    humidity = 0;
  }
}

void timeBasedControl() {
  // ========== ì‹œê°„ ê¸°ë°˜ LED ì œì–´ ==========
  if (isTimeForLED()) {
    if (!ledStatus) {
      activateLED(true);
      Serial.println("â° ì •ê¸° LED ì¼œê¸° (06:00-22:00)");
    }
  } else {
    if (ledStatus) {
      activateLED(false);
      Serial.println("â° ì •ê¸° LED ë„ê¸° (ì•¼ê°„ ëª¨ë“œ)");
    }
  }
  
  // ========== ì •ê¸° ë¬¼ì£¼ê¸° ì œì–´ ==========
  if (isTimeToWater()) {
    scheduledWatering();
  }
  
  // ========== ì •ê¸° ì‹ë¬¼ ì´ë™ ì œì–´ ==========
  if (isTimeToMovePlant()) {
    scheduledLinearMove();
  }
}

void environmentalControl() {
  // ========== ì˜¨ë„ ê¸°ë°˜ íŒ¬ ì œì–´ ==========
  if (temperature > OPTIMAL_TEMP_MAX) {
    if (!fanStatus) {
      activateFans(true);
      Serial.println("ğŸŒ¡ï¸ ê³ ì˜¨ ê°ì§€ - íŒ¬ ê°€ë™");
    }
  } else if (temperature < OPTIMAL_TEMP_MIN) {
    if (fanStatus) {
      activateFans(false);
      Serial.println("ğŸŒ¡ï¸ ì €ì˜¨ ê°ì§€ - íŒ¬ ì •ì§€ (ë³´ì˜¨)");
    }
  }
  
  // ========== ìŠµë„ ê¸°ë°˜ ì¶”ê°€ ì œì–´ ==========
  if (humidity < OPTIMAL_HUMIDITY_MIN) {
    // ìŠµë„ê°€ ë‚®ìœ¼ë©´ ì¶”ê°€ ë¬¼ì£¼ê¸° (ì •ê¸° ë¬¼ì£¼ê¸°ì™€ ë³„ê°œ)
    if (!wateringActive && !pumpStatus) {
      Serial.println("ğŸ’§ ì €ìŠµë„ ê°ì§€ - ì¶”ê°€ ë¬¼ì£¼ê¸°");
      activatePumps(true);
      // ì§§ì€ ì‹œê°„ ì¶”ê°€ ë¬¼ì£¼ê¸°
      delay(5000); // 5ì´ˆ
      activatePumps(false);
    }
  } else if (humidity > OPTIMAL_HUMIDITY_MAX) {
    // ìŠµë„ê°€ ë†’ìœ¼ë©´ íŒ¬ ê°€ë™ìœ¼ë¡œ ì œìŠµ
    if (!fanStatus) {
      activateFans(true);
      Serial.println("ğŸ’§ ê³ ìŠµë„ ê°ì§€ - ì œìŠµìš© íŒ¬ ê°€ë™");
    }
  }
  
  // ========== ì¡°ë„ ê¸°ë°˜ ì¶”ê°€ LED ì œì–´ ==========
  // ë‚® ì‹œê°„ëŒ€ì—ë„ ì¡°ë„ê°€ ë¶€ì¡±í•˜ë©´ LED ê°•ì œ ì¼œê¸°
  if (isTimeForLED() && lightLevel < OPTIMAL_LIGHT_MIN) {
    if (!ledStatus) {
      activateLED(true);
      Serial.println("â˜€ï¸ ì¡°ë„ ë¶€ì¡± - LED ê°•ì œ ì¼œê¸°");
    }
  }
  // ë°¤ ì‹œê°„ëŒ€ì—ë„ ì¡°ë„ê°€ ê³¼ë„í•˜ë©´ LED ë„ê¸° (ì ˆì „)
  else if (!isTimeForLED() && lightLevel > OPTIMAL_LIGHT_MAX) {
    if (ledStatus) {
      activateLED(false);
      Serial.println("ğŸŒ™ ì•¼ê°„ ê³¼ë„ ì¡°ë„ - LED ë„ê¸°");
    }
  }
}

bool isTimeForLED() {
  int currentHour = now.hour();
  return (currentHour >= LED_ON_HOUR && currentHour < LED_OFF_HOUR);
}

bool isTimeToWater() {
  int currentHour = now.hour();
  int currentMinute = now.minute();
  
  // ì˜¤ì „ 8ì‹œ ë¬¼ì£¼ê¸°
  if (currentHour == WATERING_HOUR_1 && currentMinute == WATERING_MINUTE && !todayWatering1Done) {
    todayWatering1Done = true;
    return true;
  }
  
  // ì˜¤í›„ 6ì‹œ ë¬¼ì£¼ê¸°
  if (currentHour == WATERING_HOUR_2 && currentMinute == WATERING_MINUTE && !todayWatering2Done) {
    todayWatering2Done = true;
    return true;
  }
  
  return false;
}

bool isTimeToMovePlant() {
  int currentHour = now.hour();
  int currentMinute = now.minute();
  
  // ì˜¤ì „ 10ì‹œ ì´ë™
  if (currentHour == LINEAR_MOVE_HOUR_1 && currentMinute == LINEAR_MOVE_MINUTE && !todayLinearMove1Done) {
    todayLinearMove1Done = true;
    return true;
  }
  
  // ì˜¤í›„ 3ì‹œ ì´ë™
  if (currentHour == LINEAR_MOVE_HOUR_2 && currentMinute == LINEAR_MOVE_MINUTE && !todayLinearMove2Done) {
    todayLinearMove2Done = true;
    return true;
  }
  
  return false;
}

void scheduledWatering() {
  if (!wateringActive) {
    Serial.println("â° ì •ê¸° ë¬¼ì£¼ê¸° ì‹œì‘");
    activatePumps(true);
    wateringActive = true;
    wateringStartTime = millis();
  }
}

void scheduledLinearMove() {
  Serial.println("â° ì •ê¸° ì‹ë¬¼ ìœ„ì¹˜ ì¡°ì • ì‹œì‘");
  moveLinearActuator();
}

void activatePumps(bool activate) {
  if (activate) {
    digitalWrite(PUMP1_PIN, HIGH);
    digitalWrite(PUMP2_PIN, HIGH);
    pumpStatus = true;
  } else {
    digitalWrite(PUMP1_PIN, LOW);
    digitalWrite(PUMP2_PIN, LOW);
    pumpStatus = false;
  }
}

void activateFans(bool activate) {
  if (activate) {
    digitalWrite(FAN1_PIN, HIGH);
    digitalWrite(FAN2_PIN, HIGH);
    digitalWrite(FAN3_PIN, HIGH);
    digitalWrite(FAN4_PIN, HIGH);
    fanStatus = true;
  } else {
    digitalWrite(FAN1_PIN, LOW);
    digitalWrite(FAN2_PIN, LOW);
    digitalWrite(FAN3_PIN, LOW);
    digitalWrite(FAN4_PIN, LOW);
    fanStatus = false;
  }
}

void activateLED(bool activate) {
  if (activate) {
    digitalWrite(LED_PIN, HIGH);
    ledStatus = true;
  } else {
    digitalWrite(LED_PIN, LOW);
    ledStatus = false;
  }
}

void moveLinearActuator() {
  Serial.println("ğŸ”„ ì„ í˜• ì•¡ì¶”ì—ì´í„° ì´ë™ ì¤‘...");
  
  // ì•ìœ¼ë¡œ 100ìŠ¤í… ì´ë™
  for (int i = 0; i < 100; i++) {
    stepper.step(1);
    delay(10);
  }
  
  delay(3000); // 3ì´ˆ ëŒ€ê¸°
  
  // ë’¤ë¡œ 100ìŠ¤í… ì´ë™ (ì›ìœ„ì¹˜)
  for (int i = 0; i < 100; i++) {
    stepper.step(-1);
    delay(10);
  }
  
  Serial.println("âœ… ì„ í˜• ì•¡ì¶”ì—ì´í„° ì´ë™ ì™„ë£Œ");
}

void printSystemStatus() {
  Serial.println("\n========== ì‹œìŠ¤í…œ ìƒíƒœ ==========");
  Serial.print("í˜„ì¬ ì‹œê°„: ");
  Serial.println(formatTime(now));
  Serial.print("í˜„ì¬ ë‚ ì§œ: ");
  Serial.println(formatDate(now));
  
  Serial.print("ì˜¨ë„: ");
  Serial.print(temperature);
  Serial.print("Â°C (ìµœì : ");
  Serial.print(OPTIMAL_TEMP_MIN);
  Serial.print("-");
  Serial.print(OPTIMAL_TEMP_MAX);
  Serial.println("Â°C)");
  
  Serial.print("ìŠµë„: ");
  Serial.print(humidity);
  Serial.print("% (ìµœì : ");
  Serial.print(OPTIMAL_HUMIDITY_MIN);
  Serial.print("-");
  Serial.print(OPTIMAL_HUMIDITY_MAX);
  Serial.println("%)");
  
  Serial.print("ì¡°ë„: ");
  Serial.print(lightLevel);
  Serial.print(" (ìµœì : ");
  Serial.print(OPTIMAL_LIGHT_MIN);
  Serial.print("-");
  Serial.print(OPTIMAL_LIGHT_MAX);
  Serial.println(")");
  
  Serial.print("ì œì–´ ìƒíƒœ - íŒí”„: ");
  Serial.print(pumpStatus ? "ON" : "OFF");
  Serial.print(", íŒ¬: ");
  Serial.print(fanStatus ? "ON" : "OFF");
  Serial.print(", LED: ");
  Serial.println(ledStatus ? "ON" : "OFF");
  
  // ì˜¤ëŠ˜ ì™„ë£Œëœ ì‘ì—… í‘œì‹œ
  Serial.print("ì˜¤ëŠ˜ ì™„ë£Œëœ ì‘ì—… - ë¬¼ì£¼ê¸°1: ");
  Serial.print(todayWatering1Done ? "ì™„ë£Œ" : "ëŒ€ê¸°");
  Serial.print(", ë¬¼ì£¼ê¸°2: ");
  Serial.print(todayWatering2Done ? "ì™„ë£Œ" : "ëŒ€ê¸°");
  Serial.print(", ì‹ë¬¼ì´ë™1: ");
  Serial.print(todayLinearMove1Done ? "ì™„ë£Œ" : "ëŒ€ê¸°");
  Serial.print(", ì‹ë¬¼ì´ë™2: ");
  Serial.println(todayLinearMove2Done ? "ì™„ë£Œ" : "ëŒ€ê¸°");
  
  if (wateringActive) {
    Serial.println("ğŸ’§ ë¬¼ì£¼ê¸° ì§„í–‰ ì¤‘...");
  }
  
  Serial.println("================================\n");
}

void sendToESP32() {
  // JSON í˜•íƒœë¡œ ESP32ì— ë°ì´í„° ì „ì†¡
  String jsonData = "{";
  jsonData += "\"temperature\":" + String(temperature, 2) + ",";
  jsonData += "\"humidity\":" + String(humidity, 2) + ",";
  jsonData += "\"lightLevel\":" + String(lightLevel) + ",";
  jsonData += "\"pumpStatus\":" + String(pumpStatus ? "true" : "false") + ",";
  jsonData += "\"fanStatus\":" + String(fanStatus ? "true" : "false") + ",";
  jsonData += "\"ledStatus\":" + String(ledStatus ? "true" : "false") + ",";
  jsonData += "\"wateringActive\":" + String(wateringActive ? "true" : "false") + ",";
  jsonData += "\"currentTime\":\"" + formatTime(now) + "\",";
  jsonData += "\"currentDate\":\"" + formatDate(now) + "\",";
  jsonData += "\"watering1Done\":" + String(todayWatering1Done ? "true" : "false") + ",";
  jsonData += "\"watering2Done\":" + String(todayWatering2Done ? "true" : "false") + ",";
  jsonData += "\"linearMove1Done\":" + String(todayLinearMove1Done ? "true" : "false") + ",";
  jsonData += "\"linearMove2Done\":" + String(todayLinearMove2Done ? "true" : "false") + ",";
  jsonData += "\"timestamp\":" + String(now.unixtime());
  jsonData += "}";
  
  // ESP32ë¡œ ì „ì†¡
  esp32Serial.println(jsonData);
  
  Serial.println("ğŸ“¡ ESP32ë¡œ ë°ì´í„° ì „ì†¡ ì™„ë£Œ");
}

String formatTime(DateTime dt) {
  String timeString = "";
  if (dt.hour() < 10) timeString += "0";
  timeString += String(dt.hour()) + ":";
  if (dt.minute() < 10) timeString += "0";
  timeString += String(dt.minute()) + ":";
  if (dt.second() < 10) timeString += "0";
  timeString += String(dt.second());
  return timeString;
}

String formatDate(DateTime dt) {
  String dateString = "";
  dateString += String(dt.year()) + "-";
  if (dt.month() < 10) dateString += "0";
  dateString += String(dt.month()) + "-";
  if (dt.day() < 10) dateString += "0";
  dateString += String(dt.day());
  return dateString;
}

void emergencyStop() {
  activatePumps(false);
  activateFans(false);
  activateLED(false);
  digitalWrite(ENABLE_PIN, LOW); // ìŠ¤í…ëª¨í„° ë¹„í™œì„±í™”
  
  Serial.println("ğŸš¨ ë¹„ìƒ ì •ì§€ ì‘ë™!");
  Serial.println("ëª¨ë“  ì‹œìŠ¤í…œ ì •ì§€ë¨");

}