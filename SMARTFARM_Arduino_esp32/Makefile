# ìŠ¤ë§ˆíŠ¸íŒœ ì‹œìŠ¤í…œ Makefile
# PlatformIO ê¸°ë°˜ ë¹Œë“œ ìë™í™”

# ê¸°ë³¸ ì„¤ì •
PROJECT_NAME = SmartFarm
VERSION = 2.0.0
BOARD = uno
ENV = uno

# ìƒ‰ìƒ ì •ì˜
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# ê¸°ë³¸ íƒ€ê²Ÿ
.DEFAULT_GOAL := help

# ë„ì›€ë§
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ í‘œì‹œ
	@echo "$(BLUE)ğŸŒ± ìŠ¤ë§ˆíŠ¸íŒœ ì‹œìŠ¤í…œ ë¹Œë“œ ë„êµ¬ v$(VERSION)$(NC)"
	@echo ""
	@echo "$(YELLOW)ì‚¬ìš©ë²•:$(NC)"
	@echo "  make <target>"
	@echo ""
	@echo "$(YELLOW)ì£¼ìš” ëª…ë ¹ì–´:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(YELLOW)í™˜ê²½:$(NC)"
	@echo "  BOARD: $(BOARD)"
	@echo "  ENV: $(ENV)"

# ë¹Œë“œ ê´€ë ¨
build: ## í”„ë¡œì íŠ¸ ë¹Œë“œ
	@echo "$(YELLOW)ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘...$(NC)"
	pio run -e $(ENV)
	@echo "$(GREEN)âœ… ë¹Œë“œ ì™„ë£Œ$(NC)"

clean: ## ë¹Œë“œ íŒŒì¼ ì •ë¦¬
	@echo "$(YELLOW)ğŸ§¹ ë¹Œë“œ íŒŒì¼ ì •ë¦¬ ì¤‘...$(NC)"
	pio run -t clean
	@echo "$(GREEN)âœ… ì •ë¦¬ ì™„ë£Œ$(NC)"

rebuild: clean build ## í´ë¦° ë¹Œë“œ

# ì—…ë¡œë“œ ê´€ë ¨
upload: ## íŒì›¨ì–´ ì—…ë¡œë“œ
	@echo "$(YELLOW)ğŸ“¤ íŒì›¨ì–´ ì—…ë¡œë“œ ì¤‘...$(NC)"
	pio run -e $(ENV) -t upload
	@echo "$(GREEN)âœ… ì—…ë¡œë“œ ì™„ë£Œ$(NC)"

monitor: ## ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì‹œì‘
	@echo "$(YELLOW)ğŸ“º ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì‹œì‘...$(NC)"
	pio device monitor

upload-monitor: upload monitor ## ì—…ë¡œë“œ í›„ ëª¨ë‹ˆí„°ë§

# í…ŒìŠ¤íŠ¸ ê´€ë ¨
test: ## ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	pio test -e test
	@echo "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

test-sensors: ## ì„¼ì„œ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ“Š ì„¼ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	pio test -f test_sensors
	@echo "$(GREEN)âœ… ì„¼ì„œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

test-actuators: ## ì•¡ì¶”ì—ì´í„° í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "$(YELLOW)âš™ï¸ ì•¡ì¶”ì—ì´í„° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	pio test -f test_actuators
	@echo "$(GREEN)âœ… ì•¡ì¶”ì—ì´í„° í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

test-scheduler: ## ìŠ¤ì¼€ì¤„ëŸ¬ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "$(YELLOW)â° ìŠ¤ì¼€ì¤„ëŸ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	pio test -f test_scheduler
	@echo "$(GREEN)âœ… ìŠ¤ì¼€ì¤„ëŸ¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

test-verbose: ## ìƒì„¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ” ìƒì„¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	pio test -v
	@echo "$(GREEN)âœ… ìƒì„¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

# ê°œë°œ í™˜ê²½
setup: ## ê°œë°œ í™˜ê²½ ì„¤ì •
	@echo "$(YELLOW)ğŸ› ï¸ ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘...$(NC)"
	@echo "PlatformIO ì„¤ì¹˜ í™•ì¸..."
	@which pio > /dev/null || (echo "$(RED)âŒ PlatformIOê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤$(NC)" && exit 1)
	@echo "ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì„¤ì¹˜..."
	pio lib install
	@echo "$(GREEN)âœ… ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ$(NC)"

check: ## ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
	@echo "$(YELLOW)ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘...$(NC)"
	pio check
	@echo "$(GREEN)âœ… ê²€ì‚¬ ì™„ë£Œ$(NC)"

format: ## ì½”ë“œ í¬ë§·íŒ…
	@echo "$(YELLOW)âœ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘...$(NC)"
	find src include -name "*.cpp" -o -name "*.h" | xargs clang-format -i
	@echo "$(GREEN)âœ… í¬ë§·íŒ… ì™„ë£Œ$(NC)"

# ë¬¸ì„œí™”
docs: ## ë¬¸ì„œ ìƒì„±
	@echo "$(YELLOW)ğŸ“š ë¬¸ì„œ ìƒì„± ì¤‘...$(NC)"
	doxygen Doxyfile 2>/dev/null || echo "$(YELLOW)âš ï¸ Doxygenì´ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ$(NC)"
	@echo "$(GREEN)âœ… ë¬¸ì„œ ìƒì„± ì™„ë£Œ$(NC)"

# ë°°í¬ ê´€ë ¨
package: build ## ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
	@echo "$(YELLOW)ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘...$(NC)"
	@mkdir -p dist
	@cp .pio/build/$(ENV)/firmware.hex dist/$(PROJECT_NAME)-v$(VERSION).hex
	@cp .pio/build/$(ENV)/firmware.elf dist/$(PROJECT_NAME)-v$(VERSION).elf
	@echo "íŒ¨í‚¤ì§€ ë‚´ìš©:" > dist/package-info.txt
	@echo "í”„ë¡œì íŠ¸: $(PROJECT_NAME)" >> dist/package-info.txt
	@echo "ë²„ì „: $(VERSION)" >> dist/package-info.txt
	@echo "ë¹Œë“œ ë‚ ì§œ: $$(date)" >> dist/package-info.txt
	@echo "ë³´ë“œ: $(BOARD)" >> dist/package-info.txt
	@echo "$(GREEN)âœ… íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ: dist/$(NC)"

release: clean test package ## ë¦´ë¦¬ì¦ˆ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ + íŒ¨í‚¤ì§•)
	@echo "$(GREEN)ğŸš€ ë¦´ë¦¬ì¦ˆ v$(VERSION) ì¤€ë¹„ ì™„ë£Œ$(NC)"

# í™˜ê²½ë³„ ë¹Œë“œ
build-uno: ## Arduino Unoìš© ë¹Œë“œ
	$(MAKE) build ENV=uno BOARD=uno

build-esp32: ## ESP32ìš© ë¹Œë“œ
	$(MAKE) build ENV=esp32 BOARD=esp32dev

build-debug: ## ë””ë²„ê·¸ ëª¨ë“œ ë¹Œë“œ
	$(MAKE) build ENV=debug

build-release: ## ë¦´ë¦¬ì¦ˆ ëª¨ë“œ ë¹Œë“œ
	$(MAKE) build ENV=release

# ì‹œë®¬ë ˆì´ì…˜
simulate: ## ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ–¥ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘...$(NC)"
	pio run -e simulation
	@echo "$(GREEN)âœ… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ$(NC)"

# ìœ ì§€ë³´ìˆ˜
backup: ## í”„ë¡œì íŠ¸ ë°±ì—…
	@echo "$(YELLOW)ğŸ’¾ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘...$(NC)"
	@mkdir -p backup
	@tar -czf backup/$(PROJECT_NAME)-backup-$$(date +%Y%m%d-%H%M%S).tar.gz \
		--exclude='.pio' --exclude='backup' --exclude='.git' .
	@echo "$(GREEN)âœ… ë°±ì—… ì™„ë£Œ: backup/$(NC)"

restore: ## ë°±ì—…ì—ì„œ ë³µì› (ì‚¬ìš© ì‹œ ì£¼ì˜)
	@echo "$(RED)âš ï¸ ì´ ì‘ì—…ì€ í˜„ì¬ íŒŒì¼ì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤$(NC)"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N] " confirm && [ "$$confirm" = "y" ]
	@echo "$(YELLOW)ğŸ“¥ ë³µì›í•  ë°±ì—… íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”:$(NC)"
	@ls -la backup/

clean-all: clean ## ëª¨ë“  ìƒì„± íŒŒì¼ ì‚­ì œ
	@echo "$(YELLOW)ğŸ—‘ï¸ ëª¨ë“  ìƒì„± íŒŒì¼ ì‚­ì œ ì¤‘...$(NC)"
	rm -rf .pio
	rm -rf dist
	rm -rf docs/html
	rm -rf backup
	@echo "$(GREEN)âœ… ì‚­ì œ ì™„ë£Œ$(NC)"

# ì •ë³´ ì¶œë ¥
info: ## í”„ë¡œì íŠ¸ ì •ë³´ ì¶œë ¥
	@echo "$(BLUE)ğŸ“Š í”„ë¡œì íŠ¸ ì •ë³´$(NC)"
	@echo "ì´ë¦„: $(PROJECT_NAME)"
	@echo "ë²„ì „: $(VERSION)"
	@echo "ë³´ë“œ: $(BOARD)"
	@echo "í™˜ê²½: $(ENV)"
	@echo ""
	@echo "$(BLUE)ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°$(NC)"
	tree -I '.pio|.git|backup|dist' -L 2 || ls -la

status: ## Git ìƒíƒœ ë° ë¹Œë“œ ì •ë³´
	@echo "$(BLUE)ğŸ“‹ ìƒíƒœ ì •ë³´$(NC)"
	@echo ""
	@echo "$(YELLOW)Git ìƒíƒœ:$(NC)"
	git status --short 2>/dev/null || echo "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤"
	@echo ""
	@echo "$(YELLOW)ë¹Œë“œ ìƒíƒœ:$(NC)"
	@[ -f .pio/build/$(ENV)/firmware.hex ] && echo "âœ… íŒì›¨ì–´ ë¹Œë“œë¨" || echo "âŒ íŒì›¨ì–´ ë¯¸ë¹Œë“œ"
	@[ -d .pio/libdeps ] && echo "âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ë¨" || echo "âŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ì„¤ì¹˜"

# ê³ ê¸‰ ê¸°ëŠ¥
memory: ## ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„
	@echo "$(YELLOW)ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„ ì¤‘...$(NC)"
	pio run -e memory_profile -t size

benchmark: ## ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
	@echo "$(YELLOW)âš¡ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì¤‘...$(NC)"
	@echo "ë¹Œë“œ ì‹œê°„ ì¸¡ì •..."
	@time $(MAKE) clean > /dev/null 2>&1
	@time $(MAKE) build > /dev/null 2>&1

lint: ## ì½”ë“œ ë¦°íŒ…
	@echo "$(YELLOW)ğŸ” ì½”ë“œ ë¦°íŒ… ì¤‘...$(NC)"
	pio check --flags "--enable=all"

# OTA ì—…ë°ì´íŠ¸ (ESP32ìš©)
ota: ## OTA ë¬´ì„  ì—…ë°ì´íŠ¸
	@echo "$(YELLOW)ğŸ“¡ OTA ì—…ë°ì´íŠ¸ ì¤‘...$(NC)"
	pio run -e ota -t upload
	@echo "$(GREEN)âœ… OTA ì—…ë°ì´íŠ¸ ì™„ë£Œ$(NC)"

# ê°œë°œì ë„êµ¬
install-tools: ## ê°œë°œ ë„êµ¬ ì„¤ì¹˜
	@echo "$(YELLOW)ğŸ› ï¸ ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ì¤‘...$(NC)"
	@echo "clang-format ì„¤ì¹˜ í™•ì¸..."
	@which clang-format > /dev/null || echo "$(YELLOW)âš ï¸ clang-formatì„ ì„¤ì¹˜í•˜ì„¸ìš”$(NC)"
	@echo "doxygen ì„¤ì¹˜ í™•ì¸..."
	@which doxygen > /dev/null || echo "$(YELLOW)âš ï¸ doxygenì„ ì„¤ì¹˜í•˜ì„¸ìš”$(NC)"
	@echo "tree ì„¤ì¹˜ í™•ì¸..."
	@which tree > /dev/null || echo "$(YELLOW)âš ï¸ treeë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”$(NC)"

# í¸ì˜ ê¸°ëŠ¥
quick: build upload monitor ## ë¹Œë“œ + ì—…ë¡œë“œ + ëª¨ë‹ˆí„°ë§
dev: clean build test ## ê°œë°œìš© (í´ë¦° + ë¹Œë“œ + í…ŒìŠ¤íŠ¸)
ci: clean build test package ## CIìš© (ì „ì²´ íŒŒì´í”„ë¼ì¸)

# Phony íƒ€ê²Ÿ ì •ì˜
.PHONY: help build clean rebuild upload monitor upload-monitor test test-sensors test-actuators test-scheduler test-verbose setup check format docs package release build-uno build-esp32 build-debug build-release simulate backup restore clean-all info status memory benchmark lint ota install-tools quick dev ci